Linux User Creation & Sudo Access Using Ansible

User: venkata
Executed from: ansible server
Automation Tool: Ansible
OS: Ubuntu 22.04 (targets)

1ï¸âƒ£ Prerequisites
âœ” Ansible Installed on Control Server
ansible --version


Expected:

ansible [core 2.16.x]

âœ” Control Server User

Running commands as: root

Remote SSH user: touadmin

touadmin has sudo access on target servers

2ï¸âƒ£ Directory Structure (On Ansible Server)
/home/venkata/ansible/
â”œâ”€â”€ inventory.ini
â””â”€â”€ add_user_venkata.yml


Create directory:

mkdir -p /home/venkata/ansible
cd /home/venkata/ansible

3ï¸âƒ£ Inventory File (Server List)
ğŸ“„ File: /home/venkata/ansible/inventory.ini
[mongo_servers]
10.1xx.61.165
10.1xx.61.185
10.1xx.61.135
10.1xx.61.188
10.1xx.61.138
10.1xx.61.109
10.1xx.61.110
10.1xx.61.111
10.1xx.61.72
10.1xx.61.73
10.1xx.61.74
10.1xx.61.39
10.1xx.61.68
10.1xx.61.38
10.1xx.61.180
10.1xx.61.184

4ï¸âƒ£ Connectivity Test (Mandatory)
ğŸ” Test SSH connectivity
ansible -i inventory.ini mongo_servers -m ping -u touadmin --ask-pass


Expected:

SUCCESS => pong


âŒ Remove/comment any unreachable hosts before proceeding.

5ï¸âƒ£ Generate Secure Password Hash

Linux stores hashed passwords, not plain text.

ğŸ” Command Used
python3 - <<EOF
import crypt
print(crypt.crypt("xuv7ooax5", crypt.mksalt(crypt.METHOD_SHA512)))
EOF

ğŸ“Œ Generated Hash (Example)
$6$Ow9e8fkQEIDzbJ6h$pTdb5NG3clcMGP/4v0gJB.YSeWRqU4z3/dsjDsKG4j9p9eYlNhKuRGz21f5pK0XgPpWGs3gxpnllF995/dTgj1


âš ï¸ Store hash only, never the plain password.

6ï¸âƒ£ Ansible Playbook (User + Sudo Access)
ğŸ“„ File: /home/venkata/ansible/add_user_venkata.yml
---
- name: Create Linux user venkata and grant sudo access
  hosts: mongo_servers
  become: yes

  vars:
    username: venkata
    user_password: "$6$Ow9e8fkQEIDzbJ6h$pTdb5NG3clcMGP/4v0gJB.YSeWRqU4z3/dsjDsKG4j9p9eYlNhKuRGz21f5pK0XgPpWGs3gxpnllF995/dTgj1"

  tasks:
    - name: Ensure venkata user exists
      ansible.builtin.user:
        name: "{{ username }}"
        password: "{{ user_password }}"
        shell: /bin/bash
        create_home: yes
        state: present

    - name: Add venkata to sudo group
      ansible.builtin.user:
        name: "{{ username }}"
        groups: sudo
        append: yes

7ï¸âƒ£ Execute the Playbook
â–¶ï¸ First-Time Run (Password Based)
ansible-playbook -i inventory.ini add_user_venkata.yml \
  -u touadmin --ask-pass --ask-become-pass


Prompts:

SSH password â†’ touadmin

BECOME password â†’ touadmin

8ï¸âƒ£ Expected Output (Success)
TASK [Ensure venkata user exists] â†’ changed
PLAY RECAP â†’ failed=0 unreachable=0


changed=1 â†’ user created + sudo added

Safe to re-run (idempotent)

9ï¸âƒ£ Verification Commands
ğŸ” Check user existence
ansible -i inventory.ini mongo_servers -u touadmin -b \
  -m command -a "id venkata"

ğŸ” Check sudo group
ansible -i inventory.ini mongo_servers -u touadmin -b \
  -m command -a "groups venkata"


Expected:

venkata : venkata sudo

ğŸ” Manual login test
ssh venkata@10.1xx.61.165

ğŸ” Optional (Production Best Practices)
A) Force password change on first login
- name: Force password change on first login
  command: chage -d 0 venkata

B) Passwordless sudo for venkata (Optional)
- name: Allow venkata passwordless sudo
  copy:
    dest: /etc/sudoers.d/venkata
    content: "venkata ALL=(ALL) NOPASSWD:ALL\n"
    mode: '0440'

C) SSH Key-Based Access (Recommended)
ssh-keygen
ansible mongo_servers -i inventory.ini -u touadmin --ask-pass \
  -m authorized_key \
  -a "user=touadmin state=present key='{{ lookup('file', '/root/.ssh/id_rsa.pub') }}'"


Then run playbooks without passwords:

ansible-playbook -i inventory.ini add_user_venkata.yml -u touadmin --become

ğŸ” Rollback (If Required)
Remove user:
- name: Remove venkata user
  user:
    name: venkata
    state: absent
    remove: yes

âœ… Final Summary
Item	Status
User creation	âœ… Automated
Sudo access	âœ… Granted
Security	âœ… Hashed password
Scalability	âœ… Any number of servers
Re-run safe	âœ… Idempotent
